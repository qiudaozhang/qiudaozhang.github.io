<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/a11y-light.min.css"
          integrity="sha512-WDk6RzwygsN9KecRHAfm9HTN87LQjqdygDmkHSJxVkVI7ErCZ8ZWxP6T8RvBujY1n2/E4Ac+bn2ChXnp5rnnHA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
<!--    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.2/css/bootstrap-grid.css" rel="stylesheet">-->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="../meta_css//domain.css">

    <title>网关根据IP与访问api进行一定访问控制</title>
</head>
<body>
<div>
    <a href="https://qiudaozhang.github.io">首页</a>
</div>

<div class="row">
    <div class="col-sm-2 col-2">
        <!-- 左侧预留 -->
    </div>
    <div class="col-sm-8 col-8">
        <div>
            <h1>网关根据IP与访问api进行一定访问控制</h1>
        </div>
        <div>
            <pre><code class="language-java"> import cn.hutool.json.JSONUtil;
import com.luhongkj.service.RedisService;
import com.ucc.common.R;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.http.MediaType;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import reactor.core.publisher.Mono;

import javax.annotation.Resource;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

/**
 * 请求频率限制
 */
@Component
//@Order(1000)
@Slf4j
public class RateLimitFilter implements GlobalFilter, Ordered {


    @Resource
    private RedisService redisService;


    @Data
    @AllArgsConstructor
    static class LimitDto {
        // 需要限流的路径
        private String path;
        // 需要限流的时间，单位为秒
        private Integer time;
    }

    private static List&lt;LimitDto&gt; limits = List.of(
            new LimitDto(&quot;/app/api/test/speed&quot;, 1),
            new LimitDto(&quot;/app/api/order/pay&quot;, 5),
            new LimitDto(&quot;/app/api/order/open&quot;, 5)
    );


    @Override
    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) {
//        log.info(&quot;rate limit &quot;);
        ServerHttpRequest request = exchange.getRequest();
        String uriPath = request.getPath().value();
        String ip = Objects.requireNonNull(request.getRemoteAddress()).getAddress().getHostAddress();
        Optional&lt;LimitDto&gt; op = limits.stream().filter(limit -&gt; limit.getPath().equals(uriPath)).findFirst();

        if (op.isPresent()) {
            LimitDto limitDto = op.get();

            Integer time = limitDto.getTime();
            log.info(&quot;需要进行限制频率&quot;);
            String limit_key = ip + uriPath;
            log.info(limit_key);
            if (redisService.hasKey(limit_key)) {
                log.info(&quot;执行限流&quot;);
                exchange.getResponse().getHeaders().set(&quot;Content-Type&quot;, MediaType.APPLICATION_JSON_VALUE);
                R&lt;Object&gt; r = R.fail(500, &quot;当前操作过于频繁&quot;);
                String value = JSONUtil.toJsonStr(r);
                return exchange.getResponse().writeWith(Mono.just(exchange.getResponse().bufferFactory().wrap(value.getBytes())));
            } else {
                log.info(&quot;写入限流&quot;);
                redisService.set(limit_key, 1, time);
            }
        }

        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return -60000;
    }
}
</code></pre>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"
        integrity="sha512-gU7kztaQEl7SHJyraPfZLQCNnrKdaQi5ndOyt4L4UPL/FHDd/uB9Je6KDARIqwnNNE27hnqoWLBq+Kpe4iHfeQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- 代码高亮 -->
<script>hljs.highlightAll();</script>
</body>
</html>