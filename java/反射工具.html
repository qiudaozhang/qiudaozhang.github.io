<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/a11y-light.min.css"
          integrity="sha512-WDk6RzwygsN9KecRHAfm9HTN87LQjqdygDmkHSJxVkVI7ErCZ8ZWxP6T8RvBujY1n2/E4Ac+bn2ChXnp5rnnHA=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
<!--    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.2/css/bootstrap-grid.css" rel="stylesheet">-->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="../meta_css//domain.css">

    <title>反射工具</title>
</head>
<body>
<div>
    <a href="https://qiudaozhang.github.io">首页</a>
</div>

<div class="row">
    <div class="col-sm-2 col-2">
        <!-- 左侧预留 -->
    </div>
    <div class="col-sm-8 col-8">
        <div>
            <h1>反射工具</h1>
        </div>
        <div>
            <pre><code class="language-java">package com.jfreeu.admin.component;

import cn.dev33.satoken.annotation.SaCheckLogin;
import cn.dev33.satoken.annotation.SaCheckPermission;
import com.jfreeu.entity.BackPermission;
import com.jfreeu.service.BackPermissionService;
import org.apache.dubbo.config.annotation.DubboReference;
import org.reflections.Reflections;
import org.reflections.scanners.MethodAnnotationsScanner;
import org.reflections.scanners.SubTypesScanner;
import org.reflections.scanners.TypeAnnotationsScanner;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;
import java.lang.annotation.Annotation;
import java.lang.reflect.Method;
import java.util.Iterator;
import java.util.Set;

/**
 * @author dao
 * @since 2022-11-25
 * 后端权限自动存储
 */
@Component
public class PermissionStore {

    @DubboReference
    private BackPermissionService backPermissionService;


    @PostConstruct
    public void run() {
        var ref = new Reflections(&quot;com.jfreeu.admin&quot;, new TypeAnnotationsScanner(), new SubTypesScanner(), new MethodAnnotationsScanner());
        Set&lt;Method&gt; methods = ref.getMethodsAnnotatedWith(SaCheckPermission.class);
        Iterator&lt;Method&gt; it = methods.iterator();
        while (it.hasNext()) {
            Method next = it.next();
            Annotation[] annotations = next.getDeclaredAnnotations();
            for (Annotation annotation : annotations) {
                if (annotation instanceof SaCheckPermission) {
                    SaCheckPermission p = (SaCheckPermission) annotation;
                    var pv = p.value()[0];
                    long count = backPermissionService.countPermission(pv);
                    if (count == 0) {
                        BackPermission bp = new BackPermission();
                        bp.setName(pv);
                        backPermissionService.save(bp);
                    }
                }
            }
        }
    }

    public static void main(String[] args) {
        var ref = new Reflections(&quot;com.jfreeu.admin&quot;, new TypeAnnotationsScanner(), new SubTypesScanner(), new MethodAnnotationsScanner());
        Set&lt;Method&gt; methods = ref.getMethodsAnnotatedWith(SaCheckPermission.class);
        Iterator&lt;Method&gt; it = methods.iterator();
        while (it.hasNext()) {
            Method next = it.next();
            Annotation[] annotations = next.getDeclaredAnnotations();
            for (Annotation annotation : annotations) {
                if (annotation instanceof SaCheckPermission) {
                    SaCheckPermission p = (SaCheckPermission) annotation;
                    System.out.println(p.value()[0]);
                }
            }
        }
    }

}
</code></pre>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"
        integrity="sha512-gU7kztaQEl7SHJyraPfZLQCNnrKdaQi5ndOyt4L4UPL/FHDd/uB9Je6KDARIqwnNNE27hnqoWLBq+Kpe4iHfeQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- 代码高亮 -->
<script>hljs.highlightAll();</script>
</body>
</html>